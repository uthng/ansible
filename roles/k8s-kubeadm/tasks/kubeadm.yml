- name: "Kubeadm | Copy etcd certificates from local"
  copy:
    src: "{{ item }}"
    dest: "{{ kubeadm_pki_etcd_dir }}"
    mode: 0644
  with_items:
    - "{{ kubeadm_pki_etcd_ca }}"
    - "{{ kubeadm_pki_etcd_client }}"
    - "{{ kubeadm_pki_etcd_client_key }}"
  when: kubeadm_pki_etcd_src is defined and kubeadm_pki_etcd_src == "local"
  tags:
    - kubeadm-cluster-setup

- name: "Kubeadm | Copy etcd certificates from remote etcd server"
  shell: "scp root@{{ kubeadm_pki_etcd_src_server }}:{{ kubeadm_pki_etcd_src_dir }}/{{ item }} {{ kubeadm_pki_etcd_dir }}"
  with_items:
    - "{{ kubeadm_pki_etcd_ca }}"
    - "{{ kubeadm_pki_etcd_client }}"
    - "{{ kubeadm_pki_etcd_client_key }}"
  when: kubeadm_pki_etcd_src is defined and kubeadm_pki_etcd_src == "remote"
  tags:
    - kubeadm-cluster-setup

- name: "Kubeadm | Copy k8s master config file"
  template:
    src: "k8s_master_config.yml.j2"
    dest: "{{ ansible_env.HOME }}/config.yml"
  tags:
    - kubeadm-cluster-setup

- name: "Kubeadm | Initialize 1st master"
  shell: "kubeadm init --config=$HOME/config.yml"
  register: master_initialized
  run_once: yes
  tags:
    - kubeadm-cluster-setup

# Maybe must check if the master gets ready

- name: "Kubeadm | Set variables after cluster initialization"
  set_fact:
    kubeadm_master_host: "{{ inventory_hostname }}"
    kubeadm_master_host_ip: "{{ hostvars[inventory_hostname]['ansible_' + kubeadm_interface]['ipv4']['address'] }}"
    kubeadm_worker_join_command: "{{ master_initialized.stdout_lines|last|trim }}"
  run_once: yes
  tags:
    - kubeadm-cluster-setup

- name: "Kubeadm | Set variables for worker"
  set_fact:
    kubeadm_worker_join_token: "{{ kubeadm_worker_join_command.split(' ')[3] }}"
    kubeadm_worker_ca_hash: "{{ kubeadm_worker_join_command.split(' ')[6] }}"
  run_once: yes
  tags:
    - kubeadm-cluster-setup

- block:
  - name: "Kubeadm | Copy pki certs generated by cluster initialization"
    shell: "scp root@{{ kubeadm_master_host_ip }}:{{ kubeadm_pki_dir }}/{{ item }} ./"
    args:
      chdir: "{{ kubeadm_pki_dir }}"
    with_items:
      - "ca.key"
      - "ca.crt"

  - name: "Kubeadm | Initialize master"
    shell: "kubeadm init --config={{ ansible_env.HOME }}/config.yml"

  when: inventory_hostname != kubeadm_master_host and master_initialized.rc == 0 
  tags:
    - kubeadm-cluster-setup
