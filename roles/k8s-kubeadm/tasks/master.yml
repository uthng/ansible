- name: "Master | Check if a master host is given"
  assert:
    that:
      - kubeadm_master_host != ""
    fail_msg: "You must specify a master host by setting kubeadm_master_host variable"
  tags:
    - kubeadm-master-join

- name: "Master | Get join token"
  include: token.yml
  run_once: yes
  tags:
    - kubeadm-master-join

- block:
  - name: "Master | Copy pki certs generated by cluster initialization"
    shell: "scp root@{{ kubeadm_master_host_ip }}:{{ kubeadm_pki_dir }}/{{ item }} ./"
    args:
      chdir: "{{ kubeadm_pki_dir }}"
    with_items:
      - "ca.key"
      - "ca.crt"
      - "sa.pub"
      - "sa.key"
      - "front-proxy-ca.crt"
      - "front-proxy-ca.key"

  - name: "Master | Join master control plane"
    shell: "kubeadm join {{ kubeadm_load_balancer_vip }}:6443 --token {{ kubeadm_join_token }} --discovery-token-ca-cert-hash {{ kubeadm_ca_hash }} --experimental-control-plane"

  when: inventory_hostname != kubeadm_master_host
  tags:
    - kubeadm-master-join
